name: Build and Release Plasmoid

permissions:
  contents: write

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install KDE/Qt6 build dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          cmake \
          ninja-build \
          extra-cmake-modules \
          qt6-base-dev \
          qt6-declarative-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          qt6-shader-baker \
          libkf6config-dev \
          libkf6coreaddons-dev \
          libplasma-dev \
          zip

    - name: Locate qsb and add to PATH
      run: |
        # qsb may be installed outside PATH on Ubuntu â€” find and expose it
        QSB_PATH=$(find /usr -name "qsb*" -type f 2>/dev/null | head -1)
        if [ -z "$QSB_PATH" ]; then
          echo "ERROR: qsb not found after installing qt6-shader-baker"
          exit 1
        fi
        echo "Found qsb at: $QSB_PATH"
        echo "$(dirname $QSB_PATH)" >> $GITHUB_PATH

    - name: Build plasmoid package
      run: |
        chmod +x build.sh
        ./build.sh

    - name: Verify package
      run: |
        ls -lh tao-widget.plasmoid
        echo "Package contents:"
        unzip -l tao-widget.plasmoid | tail -20

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: plasmoid-package
        path: tao-widget.plasmoid
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: tao-widget.plasmoid
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}